name: iOS Device CI

on:
  workflow_call:
    inputs:
      device:
        required: true
        type: string
      record_video:
        required: true
        type: boolean
      docker_tag:
        required: true
        type: string
env:
  ARTIFACT_PATH: ./screenshots

jobs:
  encointer_node:
    uses: ./.github/workflows/encointer-node.yml
    with:
      docker_tag: "1.16.2"

  ios_device_tests:
    name: iOS Device Tests
    runs-on: macos-14
    needs: encointer_node
    timeout-minutes: 60
    env:
      WS_ENDPOINT: ${{ needs.encointer_node.outputs.ws_endpoint }}

    steps:
      # Setup Environment
      - uses: actions/checkout@v4

      - name: Set Env Vars
        run: cat .github/env >> $GITHUB_ENV

      - name: Debug WS endpoint
        run: |
          echo "WS_ENDPOINT=$WS_ENDPOINT"
          [[ -n "$WS_ENDPOINT" ]] || (echo "WS_ENDPOINT is empty" && exit 1)

      - name: prepare xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_TEST_VERSION }}

      - name: "Prepare environment for ios"
        working-directory: ./scripts
        run: ./ios_init_env.sh

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install flutter wrapper
        run: ./scripts/install_flutter_wrapper.sh

      - name: "Create Simulator if iPad Pro 2nd gen"
        if: ${{ inputs.device == 'iPad Pro (12.9-inch) (2nd generation)' }}
        # Unfortunately it is not deterministic if the 16.2 or the 16.4 runtime is available
        run: |
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-2" || \
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-0"

      - name: Get dependencies (i.e., melos)
        run: .flutter/bin/dart pub get

      - name: Melos Bootstrap
        run: .flutter/bin/dart run melos bootstrap

      - name: Start simulator
        working-directory: ./scripts
        env:
          DEVICE_ID: ${{ inputs.device }}
        run: source ./ios_emulator.sh

      - name: Start screen recording
        if: ${{ inputs.record_video }}
        working-directory: ./scripts
        shell: bash
        run: |
          echo "Starting screen recording..."
          xcrun simctl io booted recordVideo --codec=h264 --mask=black recording.mov &
          echo $! > recording_pid.txt      

      - name: Run Flutter integration tests
        working-directory: ./app
        timeout-minutes: 45
        shell: bash
        run: |
          echo "ðŸš€ Running Flutter integration tests with WS_ENDPOINT=$WS_ENDPOINT"
          ../.flutter/bin/flutter drive \
            --no-enable-impeller \
            --target=test_driver/app.dart \
            --dart-define=WS_ENDPOINT="$WS_ENDPOINT" \
            --dart-define=locales=en

      - name: Stop recording and upload
        if: always()
        working-directory: ./scripts
        shell: bash
        run: |
          if [ -f recording_pid.txt ]; then
            RECORDING_PID=$(cat recording_pid.txt)
            echo "Stopping recording (pid $RECORDING_PID)..."
            kill -SIGINT $RECORDING_PID || echo "Recording process already stopped"
            sleep 5
          else
            echo "No recording in progress"
          fi
      
          mkdir -p "$TEMP_DIR"
          cp recording.mov "$TEMP_DIR" || echo "No recording found"
          cp -r "$TEMP_DIR/test"/* "$TEMP_DIR" || echo "No screenshots found"
          rm -r "$TEMP_DIR/test" || true

      - name: Upload screenshots and recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.device }}
          path: ${{ env.ARTIFACT_PATH }}
