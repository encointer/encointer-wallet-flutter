name: iOS Device CI

on:
  workflow_call:
    inputs:
      device:
        required: true
        type: string
      record_video:
        required: true
        type: boolean
      docker_tag:
        required: true
        type: string
env:
  ARTIFACT_PATH: ./screenshots

jobs:
  encointer_node:
    uses: ./.github/workflows/encointer-node.yml
    with:
      docker_tag: "1.16.2"

  ios_device_tests:
    name: iOS Device Tests
    runs-on: macos-14
    needs: encointer_node
    timeout-minutes: 60
    env:
      WS_ENDPOINT: ${{ needs.encointer_node.outputs.ws_endpoint }}

    steps:
      # Setup Environment
      - uses: actions/checkout@v4

      - name: Set Env Vars
        run: cat .github/env >> $GITHUB_ENV

      - name: Verify WS endpoint
        run: |
          if [ -z "${WS_ENDPOINT:-}" ]; then
            echo "::error::WS_ENDPOINT is empty or not set"
            exit 1
          fi

          HOST=$(echo "$WS_ENDPOINT" | sed -E 's|wss://([^/]+).*|\1|')

          if ! getent hosts "$HOST" >/dev/null; then
            echo "::error::WS_ENDPOINT host does not resolve: $HOST"
            exit 1
          fi

          echo "WS_ENDPOINT=$WS_ENDPOINT"

      - name: prepare xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_TEST_VERSION }}

      - name: "Prepare environment for ios"
        working-directory: ./scripts
        run: ./ios_init_env.sh

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install flutter wrapper
        run: ./scripts/install_flutter_wrapper.sh

      - name: "Create Simulator if iPad Pro 2nd gen"
        if: ${{ inputs.device == 'iPad Pro (12.9-inch) (2nd generation)' }}
        # Unfortunately it is not deterministic if the 16.2 or the 16.4 runtime is available
        run: |
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-2" || \
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-0"

      - name: Get dependencies (i.e., melos)
        run: .flutter/bin/dart pub get

      - name: Melos Bootstrap
        run: .flutter/bin/dart run melos bootstrap

      - name: Start simulator
        working-directory: ./scripts
        env:
          DEVICE_ID: ${{ inputs.device }}
        run: source ./ios_emulator.sh

#      - name: Run integration tests with printscreens in all languages
#        if: startsWith(github.ref, 'refs/tags/')
#        run: ./scripts/multi_language_screenshot_ci_test.sh
#        env:
#          TEMP_DIR: ${{ env.ARTIFACT_PATH }}
#          RECORD: ${{ matrix.record_video }}

      - name: Run integration tests
        run: ./scripts/ios_integration_test.sh
        env:
          TEMP_DIR: ${{ env.ARTIFACT_PATH }}
          RECORD: ${{ inputs.record_video }}

      - name: Upload screenshots and recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.device }}
          path: ${{ env.ARTIFACT_PATH }}
