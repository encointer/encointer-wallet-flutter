name: iOS Device CI

on:
  workflow_call:
    inputs:
      device:
        required: true
        type: string
      record_video:
        required: true
        type: boolean
      docker_tag:
        required: true
        type: string
env:
  ARTIFACT_PATH: ./screenshots

jobs:
  encointer_node:
    runs-on: ubuntu-latest
    outputs:
      ws_endpoint: ${{ steps.export_tunnel.outputs.ws }}

    steps:
      - uses: actions/checkout@v4

      - name: Run encointer-node
        run: |
          ./scripts/docker_run_encointer_node_notee.sh 1.16.2 &

      - name: Start Cloudflare tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          ./cloudflared tunnel --url http://localhost:9944 > tunnel.log 2>&1 &
          sleep 5

      - name: Verify Cloudflare tunnel health
        run: ./scripts/check_cloudflare_tunnel.sh

      - id: export_tunnel
        run: |
          HTTP_URL=$(grep -o 'https://[^ ]*trycloudflare.com' tunnel.log | head -n1)
          WS_URL="${HTTP_URL/https:/wss:}"
          echo "ws=$WS_URL" >> "$GITHUB_OUTPUT"

      - name: Keep node & tunnel alive
        run: |
          echo "ðŸŸ¢ Node running"
          while true; do sleep 60; done

  ios_device_tests:
    name: iOS Device Tests
    runs-on: macos-14
    needs: encointer_node
    timeout-minutes: 60
    env:
      WS_ENDPOINT: ${{ needs.encointer_node.outputs.ws_endpoint }}

    steps:
      # Setup Environment
      - uses: actions/checkout@v4

      - name: Set Env Vars
        run: cat .github/env >> $GITHUB_ENV

      - name: Debug WS endpoint
        shell: bash
        run: |
          set -euo pipefail
          
          echo "WS_ENDPOINT=$WS_ENDPOINT"
          [[ -n "$WS_ENDPOINT" ]] || (echo "âŒ WS_ENDPOINT is empty" && exit 1)
          
          # Convert WS â†’ HTTP for health check
          HTTP_URL="${WS_ENDPOINT/wss:/https:}"
          
          echo "ðŸŒ HTTP endpoint: $HTTP_URL"
          echo "ðŸ”Ž Performing JSON-RPC health check..."
          
          JSON_PAYLOAD='{"jsonrpc":"2.0","id":1,"method":"system_health","params":[]}'
          
          RESPONSE=$(curl -sS \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$HTTP_URL" || true)
          
          echo "â†©ï¸ Raw response:"
          echo "$RESPONSE"
          
          # Validate JSON-RPC success
          echo "$RESPONSE" | jq -e '.result' >/dev/null
          
          echo "âœ… JSON-RPC health check passed"

      - name: prepare xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_TEST_VERSION }}

      - name: "Prepare environment for ios"
        working-directory: ./scripts
        run: ./ios_init_env.sh

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install flutter wrapper
        run: ./scripts/install_flutter_wrapper.sh

      - name: "Create Simulator if iPad Pro 2nd gen"
        if: ${{ inputs.device == 'iPad Pro (12.9-inch) (2nd generation)' }}
        # Unfortunately it is not deterministic if the 16.2 or the 16.4 runtime is available
        run: |
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-2" || \
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-0"

      - name: Get dependencies (i.e., melos)
        run: .flutter/bin/dart pub get

      - name: Melos Bootstrap
        run: .flutter/bin/dart run melos bootstrap

      - name: Start simulator
        working-directory: ./scripts
        env:
          DEVICE_ID: ${{ inputs.device }}
        run: source ./ios_emulator.sh

      - name: Start screen recording
        if: ${{ inputs.record_video }}
        shell: bash
        run: |
          echo "Starting screen recording..."
          xcrun simctl io booted recordVideo --codec=h264 --mask=black recording.mov &
          echo $! > recording_pid.txt      

      - name: Run Flutter integration tests
        working-directory: ./app
        timeout-minutes: 45
        shell: bash
        run: |
          echo "ðŸš€ Running Flutter integration tests with WS_ENDPOINT=$WS_ENDPOINT"
          ../.flutter/bin/flutter drive \
            --no-enable-impeller \
            --target=test_driver/app.dart \
            --dart-define=WS_ENDPOINT="$WS_ENDPOINT" \
            --dart-define=locales=en

      - name: Stop recording and upload
        if: always()
        shell: bash
        run: |
          if [ -f recording_pid.txt ]; then
            RECORDING_PID=$(cat recording_pid.txt)
            echo "Stopping recording (pid $RECORDING_PID)..."
            kill -SIGINT $RECORDING_PID || echo "Recording process already stopped"
            sleep 5
          else
            echo "No recording in progress"
          fi
      
          mkdir -p "${{ env.ARTIFACT_PATH }}"
          cp recording.mov "${{ env.ARTIFACT_PATH }}" || echo "No recording found"
          cp -r "${{ env.ARTIFACT_PATH }}/test"/* "${{ env.ARTIFACT_PATH }}" || echo "No screenshots found"
          rm -r "${{ env.ARTIFACT_PATH }}/test" || true

      - name: Upload screenshots and recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.device }}
          path: ${{ env.ARTIFACT_PATH }}
