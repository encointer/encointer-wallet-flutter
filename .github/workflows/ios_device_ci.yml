name: iOS Device CI

on:
  workflow_call:
    inputs:
      device:
        required: true
        type: string
      record_video:
        required: true
        type: boolean
      docker_tag:
        required: true
        type: string

env:
  ARTIFACT_PATH: ./screenshots

jobs:
  encointer_node:
    name: Encointer Node
    runs-on: ubuntu-latest
    outputs:
      ws_endpoint: ${{ steps.export.outputs.ws }}
    steps:
      - uses: actions/checkout@v4

      - name: Run encointer-node
        run: |
          docker run -d \
            -p 9944:9944 \
            encointer/encointer-node:${{ inputs.docker_tag }}

      - name: Bootstrap demo community
        run: |
          ./scripts/docker_run_encointer_client_bootstrap_demo_community.sh \
            --docker-tag=${{ inputs.docker_tag }}

      - name: Start Cloudflare tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
            -o cloudflared
          chmod +x cloudflared
          ./cloudflared tunnel --url http://localhost:9944 > tunnel.log 2>&1 &
          sleep 10

      - id: export
        name: Export WS endpoint
        run: |
          URL=$(grep -o 'https://[^ ]*trycloudflare.com' tunnel.log | head -n1)
          echo "ws=${URL/https:/wss:}" >> $GITHUB_OUTPUT

  ios_tests:
    name: iOS Tests
    runs-on: macos-14
    needs: encointer_node
    timeout-minutes: 60

    steps:
      # Setup Environment
      - uses: actions/checkout@v4

      - name: Set Env Vars
        run: cat .github/env >> $GITHUB_ENV

      - name: prepare xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_TEST_VERSION }}

      - name: "Prepare environment for ios"
        working-directory: ./scripts
        run: ./ios_init_env.sh

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install flutter wrapper
        run: ./scripts/install_flutter_wrapper.sh

      - name: "Create Simulator if iPad Pro 2nd gen"
        if: ${{ inputs.device == 'iPad Pro (12.9-inch) (2nd generation)' }}
        # Unfortunately it is not deterministic if the 16.2 or the 16.4 runtime is available
        run: |
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-2" || \
          xcrun simctl create "iPad Pro (12.9-inch) (2nd generation)" "com.apple.CoreSimulator.SimDeviceType.iPad-Pro--12-9-inch---2nd-generation-" "com.apple.CoreSimulator.SimRuntime.iOS-17-0"

      - name: Get dependencies (i.e., melos)
        run: .flutter/bin/dart pub get

      - name: Melos Bootstrap
        run: .flutter/bin/dart run melos bootstrap

      - name: Start simulator
        working-directory: ./scripts
        env:
          DEVICE_ID: ${{ inputs.device }}
        run: source ./ios_emulator.sh

#      - name: Run integration tests with printscreens in all languages
#        if: startsWith(github.ref, 'refs/tags/')
#        run: ./scripts/multi_language_screenshot_ci_test.sh
#        env:
#          TEMP_DIR: ${{ env.ARTIFACT_PATH }}
#          RECORD: ${{ matrix.record_video }}

      - name: Run integration tests
        run: ./scripts/ios_integration_test.sh
        env:
          TEMP_DIR: ${{ env.ARTIFACT_PATH }}
          RECORD: ${{ inputs.record_video }}
          WS_ENDPOINT: ${{ needs.encointer_node.outputs.ws_endpoint }}

      - name: Upload screenshots and recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.device }}
          path: ${{ env.ARTIFACT_PATH }}
