name: Encointer Node

on:
  workflow_call:
    inputs:
      docker_tag:
        required: true
        type: string
    outputs:
      ws_endpoint:
        description: "Public WebSocket endpoint of encointer-node"
        value: ${{ jobs.node.outputs.ws_endpoint }}

jobs:
  node:
    runs-on: ubuntu-latest
    outputs:
      ws_endpoint: ${{ steps.export_tunnel.outputs.ws }}

    steps:
      - uses: actions/checkout@v4

      - name: Run encointer-node
        run: |
          ./scripts/docker_run_encointer_node_notee.sh ${{ inputs.docker_tag }} &

#      - name: Bootstrap demo community
#        run: |
#          ./scripts/docker_run_encointer_client_bootstrap_demo_community.sh \
#            --docker-tag=${{ inputs.docker_tag }}

      - name: Start Cloudflare tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          ./cloudflared tunnel --url http://localhost:9944 > tunnel.log 2>&1 &
          sleep 5

      - name: Verify Cloudflare tunnel health
        run: |
          set -euo pipefail
          
          HTTP_URL=$(grep -o 'https://[^ ]*trycloudflare.com' tunnel.log | head -n1)
          if [ -z "$HTTP_URL" ]; then
            echo "âŒ ERROR: Could not find tunnel URL in log"
            exit 1
          fi
          
          HOST=$(echo "$HTTP_URL" | sed -E 's|https://([^/]+).*|\1|')
          
          echo "ðŸŒ Tunnel URL: $HTTP_URL"
          echo "ðŸ”Ž Verifying tunnel is reachableâ€¦"
          
          # --- DNS check ---
          for i in {1..20}; do
            if getent hosts "$HOST" >/dev/null 2>&1; then
              echo "âœ… DNS resolved"
              break
            fi
            echo "â³ Waiting for DNS..."
            sleep 3
          done
          
          if ! getent hosts "$HOST" >/dev/null 2>&1; then
            echo "âŒ ERROR: DNS did not resolve"
            exit 1
          fi

      - id: export_tunnel
        name: Export WS endpoint
        run: |
          HTTP_URL=$(grep -o 'https://[^ ]*trycloudflare.com' tunnel.log | head -n1)
          WS_URL="${HTTP_URL/https:/wss:}"
          
          echo "ðŸ”Œ Exporting WS endpoint: $WS_URL"
          echo "ws=$WS_URL" >> "$GITHUB_OUTPUT"
